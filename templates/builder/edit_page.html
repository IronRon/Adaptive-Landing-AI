{% load static %}
<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Edit Page - {{ page.name }}</title>
    <link rel="stylesheet" href="{% static 'css/builder.css' %}">
</head>

<body>
    <main class="builder-shell">
        <div class="builder-main">
            <div class="card">
                <h1>Edit Page: {{ page.name }}</h1>

                <h3>Global CSS</h3>
                <textarea id="global-css" style="width:100%;height:150px;">{{ page.global_css }}</textarea>

                <h3 style="margin-top:16px;">Sections</h3>
                <ul id="section-list">
                    {% for s in sections %}
                    <li data-id="{{ s.id }}">
                        {{ s.key }}
                        <a href="{% url 'builder_edit_section' s.id %}">Edit</a>
                        <a href="{% url 'builder_delete_section' s.id %}">Delete</a>
                        <button class="move-up">↑</button>
                        <button class="move-down">↓</button>
                    </li>
                    {% endfor %}
                </ul>

                <div style="margin-top:12px;">
                    <a class="button" href="{% url 'builder_new_section' page.id %}">+ Add Section</a>
                </div>

                <button id="save-page" class="button button-primary" style="margin-top:12px;">Save Changes</button>
            </div>
            <div class="card" style="margin-top: 20px;">
                <h2>Recent AI Adaptations</h2>

                {% if ai_logs %}
                <ul class="builder-list">
                    {% for r in ai_logs %}
                    <li>
                        <strong>{{ r.created_at|date:"H:i d/m/Y" }}</strong><br>

                        <!-- Show key data -->
                         <div><strong>Visitor:</strong> {{ r.visitor.cookie_id }}</div><br>
                        <div><strong>Layout:</strong> {{ r.response_json.layout }}</div>

                        {% if r.response_json.customizations %}
                        <div><strong>Customized Sections:</strong>
                            {{ r.response_json.customizations.keys|join:', ' }}
                        </div>
                        {% endif %}

                        {% if r.response_json.explanation %}
                        <div><strong>Explanation:</strong> {{ r.response_json.explanation }}</div>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="placeholder">No AI responses yet.</p>
                {% endif %}
            </div>

        </div>

        <aside class="builder-side">
            <div class="card">
                <p class="builder-note">Reorder sections and update global CSS, then click Save.</p>
            </div>
        </aside>
    </main>

    <script>
        document.getElementById("save-page").onclick = function () {
            const css = document.getElementById("global-css").value;

            const list = [...document.querySelectorAll("#section-list li")];
            const sections = list.map((li, i) => ({
                id: li.dataset.id,
                order: i,
            }));

            fetch("{% url 'builder_save_page' page.id %}", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    global_css: css,
                    sections: sections
                })
            }).then(r => r.json()).then(d => {
                alert("Saved!");
                location.reload();
            });
        };

        document.querySelectorAll(".move-up").forEach(btn => {
            btn.onclick = function () {
                const li = this.parentElement;
                const prev = li.previousElementSibling;
                if (!prev) return;
                li.parentNode.insertBefore(li, prev);
            };
        });

        document.querySelectorAll(".move-down").forEach(btn => {
            btn.onclick = function () {
                const li = this.parentElement;
                const next = li.nextElementSibling;
                if (!next) return;
                li.parentNode.insertBefore(next, li);
            };
        });
    </script>
</body>

</html>